---
title: "Practical R"
author: "Sue"
date: "24/12/2019"
output: 
  html_document:
    keep_md: true
    theme: cosmo
    highlight: tango
    toc: true
    toc_depth: 5
    df_print: kable
---

```{r setup, include=FALSE}
# RMarkdown set-up; disregard this 
knitr::opts_chunk$set(echo = TRUE, include = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)
```

```{r}
library("tidyverse")
```

# Data Wrangling

We will use an example dataset, starwars, to work through data manipulations. 

```{r paged.print=TRUE}
data(starwars)
starwars
```

## **piping** (%>%) 
Base R and tidyverse R take different approaches to perform multiple functions.
Tidyverse R uses the pipe operator (`%>%`), which translates as "then."

As an example, let's calculate the average height of female Starwars characters.

<div class = "row">
<div class = "col-md-6">
<br><br> base R   
In order to perform multiple functions using base R, we perform them sequentially or nest functions. 
```{r ex1_baseR, eval = FALSE}
# sequential operations
female_height_only <- starwars[starwars$gender=="female", ]$height # subset data 
mean(female_height_only, na.rm = T) # calculate mean of the subset

# nesting subset function inside mean
colMeans(subset(starwars, # subsetting the data frame 
                subset = gender == "female", # based on the condition 
                select = "height"), # column of interest
         na.rm = T) # then perform mean on the subsetted data
```
</div>

<div class = "col-md-6">
<br><br>tidyverse R    
tidyverse uses a pipe (`%>%`) to perform multiple functions sequentially without creating an object. 
```{r ex1_tidyverseR, eval = FALSE}
starwars %>% # take the starwars dataset, then (`%>%`)
  subset(subset = gender == "female", select = "height") %>% # subset the data, then (`%>%`)
  colMeans(na.rm = T) # calculate the mean
```
</div>
</div>


The piping technique becomes handy when you...
1. have many interim stpes  
For example, when we want to run a regression with mean-centred variables   
```{r}
starwars %>% 
  group_by(gender) %>% # step 1) mean centering height around gender
  mutate(height_mc = height - mean(height, na.rm = T)) %>% 
  lm(mass ~ height_mc, # step 2) then run a regression model using the mean-centered height
     data = .) %>% 
  summary # step 3) see the summary table
```

2. do not wish to save the output (e.g., exploratory data analysis)  
For example, when we want to summarize our data and plot the summary data without saving it.
```{r}
starwars %>% 
  #filter(mass < 1000) %>% 
  group_by(gender) %>% 
  summarize_at(vars(c("height", "mass")), list(~mean(., na.rm = T), ~sd(.,na.rm = T))) %>% 
  pivot_longer(cols = -gender, 
               names_to = c("var", "stat"),
               names_sep = "_",
               values_to = "value") %>% 
  spread(stat, value) %>% 
  ggplot(aes(x = as.factor(gender), y = mean, fill = as.factor(var))) +
  geom_col(position = position_dodge(width=0.9)) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), 
                position = position_dodge(width=0.9), width = 0.25) + 
  theme_bw()
  
```



## *dplyr* verbs  

There are 5 dplyr functions that are useful for data manipulation. 



|verb|function|example|
|:-|:-|:-|
|`select()`|choose variables by (column) names|select(starwars, height, mass)|
|`filter()`|choose observations by (conditional) values|filter(starwars, gender == "none" )|
|`mutate()`|transform or create new variables|mutate(starwars, BMI = $weight/height^2$)|
|`summarize()`|summarize variables|summarize(starwars, mean_height = mean(height, na.rm = T))|
